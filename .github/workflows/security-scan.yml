name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Go Vulnerability Check (biometrics-cli)
  govulncheck-cli:
    name: Go Vulnerability Check (CLI)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: biometrics-cli/go.sum

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        working-directory: biometrics-cli
        run: govulncheck ./...

  # Go Vulnerability Check (biometrics backend)
  govulncheck-backend:
    name: Go Vulnerability Check (Backend)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: BIOMETRICS/biometrics/go.sum

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        working-directory: BIOMETRICS/biometrics
        run: govulncheck ./...

  # Secret Scanning with Gitleaks
  gitleaks:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gitleaks Action
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          config: .gitleaks.toml

      - name: Upload Gitleaks SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

  # TruffleHog Secret Scan (Secondary)
  trufflehog:
    name: Secret Scanning (TruffleHog)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: TruffleHog OSS Scan
        uses: trufflesecurity/trufflehog@v3.63.0
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # License Compliance Check
  license-check-cli:
    name: License Compliance (CLI)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check licenses
        working-directory: biometrics-cli
        run: |
          go-licenses check ./... \
            --allowed_licenses="MIT,Apache-2.0,BSD-3-Clause,BSD-2-Clause,ISC,MPL-2.0" \
            --ignore github.com/Delqhi/BIOMETRICS

      - name: Generate license report
        working-directory: biometrics-cli
        run: go-licenses report ./... --report=table > ../docs/dev/licenses-cli.txt || true

  # License Compliance Check (Backend)
  license-check-backend:
    name: License Compliance (Backend)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check licenses
        working-directory: BIOMETRICS/biometrics
        run: |
          go-licenses check ./... \
            --allowed_licenses="MIT,Apache-2.0,BSD-3-Clause,BSD-2-Clause,ISC,MPL-2.0" \
            --ignore github.com/Delqhi/BIOMETRICS

      - name: Generate license report
        working-directory: BIOMETRICS/biometrics
        run: go-licenses report ./... --report=table > ../../docs/dev/licenses-backend.txt || true

  # SAST with Semgrep
  semgrep:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Semgrep
        run: |
          semgrep ci \
            --config auto \
            --config p/golang \
            --config p/security \
            --error \
            --json \
            --output semgrep.json || true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.json
        continue-on-error: true

  # Dependency Review
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-3.0,AGPL-3.0,LGPL-3.0
          allow-ghsas:
            - GHSA-xxxx-xxxx-xxxx # Add specific GHSA IDs to allow if needed

  # CodeQL Security Analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['go', 'javascript-typescript']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [govulncheck-cli, govulncheck-backend, gitleaks, trufflehog, license-check-cli, license-check-backend, semgrep, dependency-review, codeql]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Check job statuses
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          
          for job in govulncheck-cli govulncheck-backend gitleaks trufflehog license-check-cli license-check-backend semgrep dependency-review codeql; do
            status="${{ needs.$job.result }}"
            emoji="✅"
            if [ "$status" = "failure" ]; then
              emoji="❌"
            elif [ "$status" = "cancelled" ]; then
              emoji="⚠️"
            fi
            echo "| $emoji $job | $status |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan completed:** $(date -u)" >> $GITHUB_STEP_SUMMARY
