# BIOMETRICS CLI - Local Development Environment
# Enterprise Practices Feb 2026 - Unique Ports to Avoid Conflicts

version: '3.9'

services:
  # Redis Cache Service
  # Port: 54322 (non-standard to avoid conflicts)
  redis:
    image: redis:7-alpine
    container_name: biometrics-redis-dev
    restart: unless-stopped
    ports:
      - "54322:6379"
    volumes:
      - redis_data:/data
    networks:
      - biometrics-network
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 64M

  # PostgreSQL Database Service
  # Port: 54321 (non-standard to avoid conflicts)
  postgres:
    image: postgres:15-alpine
    container_name: biometrics-postgres-dev
    restart: unless-stopped
    ports:
      - "54321:5432"
    environment:
      POSTGRES_DB: biometrics
      POSTGRES_USER: biometrics
      POSTGRES_PASSWORD: biometrics_dev
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - biometrics-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U biometrics -d biometrics"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 128M

  # Database Migration Service (Optional)
  # Runs migrations on startup
  migrate:
    image: golang:1.21-alpine
    container_name: biometrics-migrate-dev
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - .:/app
      - go_modules:/go/pkg/mod
    working_dir: /app
    command: >
      sh -c "
        echo 'Waiting for PostgreSQL...' &&
        sleep 5 &&
        echo 'Running migrations...' &&
        # Add migration command here when implemented
        echo 'Migrations complete'
      "
    networks:
      - biometrics-network
    profiles:
      - migration

  # Development Tools Container
  # Provides common development utilities
  devtools:
    image: golang:1.21-alpine
    container_name: biometrics-devtools
    restart: "no"
    volumes:
      - .:/app
      - go_modules:/go/pkg/mod
    working_dir: /app
    environment:
      - GO111MODULE=on
      - GOPROXY=https://proxy.golang.org,direct
      - CGO_ENABLED=0
    command: >
      sh -c "
        echo 'BIOMETRICS CLI Development Tools' &&
        echo '================================' &&
        echo 'Go version:' && go version &&
        echo '' &&
        echo 'Available commands:' &&
        echo '  make build     - Build the CLI' &&
        echo '  make test      - Run tests' &&
        echo '  make lint      - Run linters' &&
        echo '  make clean     - Clean build artifacts' &&
        echo ''
      "
    networks:
      - biometrics-network
    profiles:
      - tools

networks:
  biometrics-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
    labels:
      - "com.biometrics.network=development"

volumes:
  redis_data:
    driver: local
    labels:
      - "com.biometrics.volume=redis"
  
  postgres_data:
    driver: local
    labels:
      - "com.biometrics.volume=postgres"
  
  go_modules:
    driver: local
    labels:
      - "com.biometrics.volume=gomodules"

# Labels for better organization
x-common-labels: &common-labels
  com.biometrics.project: biometrics-cli
  com.biometrics.environment: development
  com.biometrics.managed-by: docker-compose

# Health check defaults
x-healthcheck-defaults: &healthcheck-defaults
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 10s

# Logging defaults
x-logging-defaults: &logging-defaults
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

# Resource limits
x-resource-limits: &resource-limits
  limits:
    cpus: '1.0'
    memory: 256M
  reservations:
    cpus: '0.25'
    memory: 64M
